<template>
  <div id='managing_contents'>
    <div class='d-flex align-items-center'>
      <h5 class='d-inline-block btn-outline-secondary mb-0'>{{ i18n.contents }}</h5>
    </div>
    <div>
      <div class="row">
        <div class="col">
          <div class="table-responsive">
            <table class="table table-hover">
              <caption>Managing content</caption>
              <thead>
                <tr>
                  <th id='managing-content-label' class='w-50'>{{ i18n.labels.text }}</th>
                  <th id='managing-content-image' class='w-50'>{{ i18n.labels.image }}</th>
                  <th id='managing-content-btn'><button type='button' class='btn btn-sm btn-primary' v-on:click='addContent'><i aria-hidden='true' class="material-icons align-middle fold">{{ icons.add }}</i></button></th>
                </tr>
              </thead>
              <tbody v-for='(content, index) in contents'>
                <tr v-if="content._destroy == '1'" class='removed'>
                  <td headers='managing-content-label'>{{ content.text }}</td>
                  <td headers='managing-content-image'>{{ i18n.labels.removed }}</td>
                  <td headers='managing-content-btn'><button type='button' v-on:click='undoRemove(index)' class='btn btn-sm btn-secondary'><i aria-hidden='true' class="material-icons align-middle fold">{{ icons.undo }}</i></button></td>
                </tr>
                <tr v-else>
                  <input type="hidden" :name="'contents[' + index + '][id]'" v-model='content.id' />
                  <td headers='managing-content-label'>
                    <div class="form-group">
                      <label for="Textarea1">{{ i18n.labels.text }}</label>
                      <textarea class="form-control" :name="'contents[' + index + '][text]'" id="Textarea1" rows="3" v-model='content.text'></textarea>
                    </div>
                  </td>
                  <td headers='managing-content-image'>

                    <input type="hidden" :name="'contents[' + index + '][keep]'" v-model='content.keep' />

                    <div class="form-group">
                      <div :class="content.preview" >
                        <div class="box box-solid">
                          <div class="d-flex box-header with-border">
                            <div><strong>{{ i18n.labels.preview }}</strong></div>
                            <div class="box-tools pull-right">
                              <button type="button" class="btn btn-danger btn-xs remove-preview" @click='onRemove(index)'>
                                <i aria-hidden='true' class="fa fa-time material-icons align-middle fold">{{ icons.delete }}</i>
                              </button>
                            </div>
                          </div>
                          <div class="box-body" >
                            <span v-if="content.image != null">
                              <img width="200" :src="content.image" alt='Content image'/>
                            </span>
                          </div>
                        </div>
                      </div>
                      <div :class="content.dropzone" @dragover='onDragOver($event, index)' @dragleave='onDragLeave($event, index)'>
                        <div class="dropzone-desc">
                          <i aria-hidden='true' class="glyphicon glyphicon-download-alt">{{ i18n.labels.dropzone }}</i>
                          <p></p>
                        </div>

                        <input type="file"
                          :name="'contents[' + index + '][image]'"
                          @change='onChange(index)'
                          accept='image/jpeg, image/png'
                          class="dropzone">
                      </div>

                    </div>

                  </td>
                  <td headers='managing-content-btn'><button type='button' class='btn btn-secondary' v-on:click='removeContent(index)'><i aria-hidden='true' class="material-icons align-middle fold">{{ icons.delete }}</i></button></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

      </div>
    </div>
  </div>
</template>
<script>
  export default {
    el: '#managing_contents',
    data: function() {
      let element = document.getElementById('managing_contents');
      let contents = []
      if (element != null) {
        contents = JSON.parse(element.dataset.contents);
        contents.forEach(function initContent(content) {
          content._destroy = null;
          content.keep = true;
          content.dropzone = 'dropzone-wrapper';
        })
      }
      let icons = {
        add: element.dataset.add,
        undo: element.dataset.undo,
        delete: element.dataset.delete
      }
      let i18n = {
        contents: element.dataset.i18nContents,
        labels: {
          dropzone: element.dataset.i18nLabelsDropzone,
          preview: element.dataset.i18nLabelsPreview,
          text: element.dataset.i18nLabelsText,
          image: element.dataset.i18nLabelsImage
        }
      }
      return { contents: contents, icons: icons, i18n: i18n }
    },
    methods: {
      addContent: function() {
        this.contents.push({
          id: null,
          text: null,
          image: null,
          _destroy: null,
          keep: false,
          preview: 'preview-zone hide',
          dropzone: 'dropzone-wrapper'
        });
      },
      removeContent: function(index) {
        let content = this.contents[index];
        if (content.id == null) {
          this.contents.splice(index, 1);
        } else {
          this.contents[index]._destroy = '1';
        }
      },
      undoRemove: function(index) {
        this.contents[index]._destroy = null;
      },
      onChange: function(index) {
        this.readFile(document.getElementsByName('contents[' + index + '][image]')[0], index);
        this.contents[index].keep = false;
      },
      onRemove(index) {
        let content = this.contents[index]
        content.image = null;
        content.keep = false;
        content.preview = 'preview-zone hide';
        document.getElementsByName('contents[' + index + '][image]')[0].value = '';
      },
      onDragOver(e, index) {
        e.preventDefault();
        e.stopPropagation();
        this.contents[index].dropzone = 'dropzone-wrapper dragover';
      },
      onDragLeave(e, index) {
        e.preventDefault();
        e.stopPropagation();
        this.contents[index].dropzone = 'dropzone-wrapper';
      },
      readFile: function(input, index) {
        if (input.files && input.files[0]) {
          let reader = new FileReader();
          let content = this.contents[index]
          reader.onload = function(e) {
            content.image = e.target.result;
            content.keep = false;
            content.preview = 'preview-zone show';
            content.dropzone = 'dropzone-wrapper';
          };
          reader.readAsDataURL(input.files[0]);
        }
      }
    }
  }
</script>
