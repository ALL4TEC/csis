class ModifyFieldsForPentests < ActiveRecord::Migration[5.2]
  def change
    add_column :reports, :subtitle, :string

    add_column :aggregates, :complexity, :string
    remove_column :aggregates, :owasp_ref

    create_table :references, id: :uuid, default: 'uuid_generate_v4()' do |t|
      t.uuid :top_id, null: false
      t.integer :rank, null: false
      t.string :name, null: false
      t.index [:rank, :top_id], name: 'references_idx_rank_top_id', unique: true
      t.index [:name, :top_id], name: 'references_idx_name_top_id', unique: true
    end

    create_table :aggregates_references, id: false do |t|
      t.uuid :aggregate_id, null: false
      t.uuid :reference_id, null: false
    end

    create_table :tops, id: :uuid, default: 'uuid_generate_v4()' do |t|
      t.string :name, null: false
    end

    create_table :reports_tops, id: false do |t|
      t.uuid :report_id, null: false
      t.uuid :top_id, null: false
    end

    add_index :dependencies, [:successor_id, :predecessor_id], name: 'dependencies_idx_pred_succ', unique: true
  end
end
