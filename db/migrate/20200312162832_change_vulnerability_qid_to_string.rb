class ChangeVulnerabilityQidToString < ActiveRecord::Migration[6.0]
  def up
    change_column :vulnerabilities, :qid, :string
    rename_column :vulnerabilities, :vuln_type, :kb_type

    Vulnerability.update_all(kb_type: :qualys)

    add_column :vulnerabilities, :import_id, :uuid
    rename_column :vulnerabilities, :solution_fr, :cvss
    change_column :vulnerabilities, :cvss, :string
    add_column :vulnerabilities, :cvss_version, :string, default: '3'
    rename_column :vulnerabilities, :diagnosis_fr, :cvss_vector
    change_column :vulnerabilities, :cvss_vector, :string
    add_column :vulnerabilities, :exploitability_score, :string
    add_column :vulnerabilities, :impact_score, :string
    add_column :vulnerabilities, :osvdb, :string
    rename_column :vulnerabilities, :bugtraq_id, :bugtraqs

    remove_index :vulnerabilities, name: "index_vulnerabilities_on_qid"
    add_index :vulnerabilities, ["kb_type", "qid"], name: "index_vulnerabilities_on_qid_and_kb_type", unique: true
  end
end
