class PentestReports < ActiveRecord::Migration[5.2]
  def change
    create_table :report_scans, id: :uuid, default: 'uuid_generate_v4()' do |t|
      t.uuid :report_scan_id
      t.text :vm_introduction
      t.text :wa_introduction
    end

    create_table :report_pentests, id: :uuid, default: 'uuid_generate_v4()' do |t|
      t.uuid :report_pentest_id
      t.text :tools
      t.text :exec_cond
      t.text :purpose
      t.text :results
    end

    tmp = Report.with_discarded.where(follow_type: 0).pluck(:id, :vm_introduction, :wa_introduction)

    remove_column :reports, :vm_introduction
    remove_column :reports, :wa_introduction

    # On utilise Wa partout ...
    rename_column :reports, :scoring_was, :scoring_wa
    rename_column :reports, :scoring_was_aggregate, :scoring_wa_aggregate

    change_column :reports, :follow_type, :string, default: 'ReportScan', null: false

    rename_column :reports, :follow_type, :type

    Report.with_discarded.update_all(type: 'ReportScan')

    tmp.each do |t|
      r = ReportScan.with_discarded.find(t[0]).update(vm_introduction: t[1], wa_introduction: t[2])
    end

    add_column :aggregates, :impact, :string
    add_column :aggregates, :owasp_ref, :string
  end
end
